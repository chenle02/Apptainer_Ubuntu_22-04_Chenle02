Bootstrap: docker
From: ubuntu:22.04

%post
    # Use the noninteractive frontend for Debian-based packages
    export DEBIAN_FRONTEND=noninteractive

    echo "tzdata tzdata/Areas select America" | debconf-set-selections
    echo "tzdata tzdata/Zones/America select New_York" | debconf-set-selections

    # Update and install basic tools
    apt-get update
    apt-get install -y \
      wget \
      curl \
      git \
      vim \
      zsh \
      python3.10 \
      python3-pip \
      nodejs \
      npm \
      gzip \
      htop \
      tzdata \
      tar

    # Install neovim following (from download now):
    # https://github.com/neovim/neovim/blob/master/INSTALL.md
    wget https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz -O /tmp/nvim-linux64.tar.gz
    tar xzvf /tmp/nvim-linux64.tar.gz -C /opt
    ln -s /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim

    # Install lazygit from GitHub releases
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    install lazygit /usr/local/bin

    # Install oh-my-zsh
    sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"

    # Install vifm, fzf, fd, rg, bat, smenu, cargo, ruby, tmux, build-essential, exuberant-ctags
    apt-get install -y \
      vifm \
      fzf \
      fd-find \
      ripgrep \
      bat \
      smenu \
      cargo \
      ruby \
      ruby-dev \
      tmux \
      build-essential \
      exuberant-ctags


    # Install lua
    apt-get install -y \
      lua5.3 \
      liblua5.3-dev \
      luarocks

    # Install delta diff tool version 0.16.5
    # https://github.com/dandavison/delta/releases
    wget https://github.com/dandavison/delta/releases/download/0.16.5/git-delta_0.16.5_amd64.deb -O git-delta.deb
    dpkg -i git-delta.deb || apt-get install -f -y
    rm git-delta.deb

    # Install nodejs, npm
    apt-get install nodejs npm -y

    apt-get update && apt-get install -y \
        tzdata \

    # Install Python packages
    pip3 install \
        sphinx \
        pygments \
        joblib \
        pytest \
        matplotlib \
        numpy \
        pandas \
        scipy \
        seaborn \
        myst_parser \
        imageio \
        jedi-language-server \
        flake8-nb \
        pyright \
        python3-neovim

    # Cleanup
    apt-get clean
    rm -rf /var/lib/apt/lists/* /var/tmp/*

    # Optionally reset DEBIAN_FRONTEND to its default value
    unset DEBIAN_FRONTEND

%environment
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    export PATH="$PATH:/root/.cargo/bin"

%runscript
    echo "This is a custom Apptainer container built from an Ubuntu Docker image!"
